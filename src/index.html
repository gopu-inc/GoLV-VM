<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GoLV - GoPu Inc. Cloud Manager</title>
    <style>
        :root {
            --primary: #00ff88;
            --primary-dim: #00ff8833;
            --bg: #0f1115;
            --card-bg: #1a1d24;
            --text: #ffffff;
            --text-dim: #8b9bb4;
            --danger: #ff4757;
            --border: #2f3542;
            --glass: rgba(26, 29, 36, 0.8);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); padding-bottom: 80px; -webkit-font-smoothing: antialiased; }

        /* --- UI COMPONENTS --- */
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Header & Nav */
        header { 
            position: sticky; top: 0; z-index: 100; 
            background: var(--glass); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .logo { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.2rem; }
        .logo svg { height: 30px; width: 30px; fill: var(--primary); }
        
        .user-pill { 
            display: flex; align-items: center; gap: 10px; 
            background: var(--card-bg); padding: 5px 15px; 
            border-radius: 20px; border: 1px solid var(--border); font-size: 0.9rem;
        }

        /* Community Section */
        .community-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;
            margin-bottom: 30px;
        }
        .comm-card {
            background: var(--card-bg); padding: 15px; border-radius: 12px;
            text-align: center; text-decoration: none; color: var(--text);
            border: 1px solid var(--border); transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .comm-card:active { transform: scale(0.98); background: var(--primary-dim); }
        .comm-card svg { width: 24px; height: 24px; fill: var(--text-dim); }

        /* Forms */
        .auth-box, .create-vm-box {
            background: var(--card-bg); padding: 25px; border-radius: 16px;
            border: 1px solid var(--border); max-width: 400px; margin: 40px auto;
        }
        input, select, textarea {
            width: 100%; padding: 12px; margin: 8px 0 20px 0;
            background: var(--bg); border: 1px solid var(--border);
            color: var(--text); border-radius: 8px; font-size: 16px;
        }
        button {
            width: 100%; padding: 14px; background: var(--primary);
            color: #000; border: none; border-radius: 8px;
            font-weight: bold; font-size: 16px; cursor: pointer;
        }
        button:disabled { opacity: 0.5; }
        .secondary-btn { background: transparent; border: 1px solid var(--border); color: var(--text); margin-top: 10px;}

        /* VM List */
        .vm-list { display: grid; gap: 15px; }
        .vm-card {
            background: var(--card-bg); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border); position: relative;
            display: flex; justify-content: space-between; align-items: center;
        }
        .vm-status {
            width: 10px; height: 10px; border-radius: 50%; background: var(--danger);
            display: inline-block; margin-right: 8px;
        }
        .vm-status.running { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        
        /* Terminal / Window */
        .window-manager {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg); z-index: 200; flex-direction: column;
        }
        .window-header {
            padding: 15px; background: var(--card-bg); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .terminal {
            flex: 1; background: #000; padding: 15px; overflow-y: auto;
            font-family: 'Courier New', monospace; font-size: 14px;
            color: var(--primary); border-bottom: 1px solid var(--border);
        }
        .terminal-output div { margin-bottom: 5px; white-space: pre-wrap; word-break: break-all;}
        .cmd-input-area {
            display: flex; padding: 10px; background: var(--card-bg);
        }
        .cmd-input-area input { margin: 0; border: none; outline: none; background: transparent; }

        /* Utils */
        .hidden { display: none !important; }
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--primary); color: #000;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; box-shadow: 0 4px 15px rgba(0,255,136,0.4);
            cursor: pointer; border: none; z-index: 90;
        }
        .error-msg { color: var(--danger); font-size: 0.9rem; margin-bottom: 10px; text-align: center;}

    </style>
</head>
<body>

    <div id="toast" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; padding: 10px 20px; border-radius: 20px; z-index: 999; display: none; font-size: 0.9rem;">Notification</div>

    <header>
        <div class="logo">
            <svg viewBox="0 0 24 24">
                <path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/>
            </svg>
            <span>GoLV<span style="color:var(--text-dim); font-size:0.8em; font-weight:normal;"> by gopu.inc</span></span>
        </div>
        <div id="user-display" class="user-pill hidden">
            <span id="username-span">Guest</span>
            <span onclick="logout()" style="color: var(--danger); cursor: pointer;">✕</span>
        </div>
    </header>

    <div class="container">
        
        <div id="view-community">
            <h2 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--text-dim);">Nos Communautés</h2>
            <div class="community-grid">
                <a href="https://www.threads.net/@mangitukamauricio/post/DSVcsKfDF3k" target="_blank" class="comm-card">
                    <svg viewBox="0 0 24 24"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2zm3.25 7.412h-2.115c-.464 0-.84.22-.84.82v.22c-.6-.723-1.32-1.04-2.193-1.04-2.074 0-3.35 1.706-3.35 4.093 0 2.457 1.348 4.085 3.393 4.085 1.127 0 1.902-.51 2.4-1.292.365 1.053 1.237 1.487 2.482 1.487 1.87 0 3.328-1.42 3.328-4.434V6.99h-3.105v6.234c0 1.02-.455 1.632-1.26 1.632-.71 0-1.11-.476-1.11-1.326V9.412zm-3.045 4.366c0 1.054-.51 1.632-1.203 1.632-.67 0-1.12-.553-1.12-1.58 0-1.106.467-1.633 1.146-1.633.68 0 1.177.536 1.177 1.58z" fill="currentColor"/></svg>
                    <span>Threads</span>
                </a>
                <a href="https://discord.gg/qWx5DszrC" target="_blank" class="comm-card">
                    <svg viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z" fill="currentColor"/></svg>
                    <span>Discord</span>
                </a>
                <a href="https://linkedin.com/in/ceoseshell" target="_blank" class="comm-card">
                    <svg viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" fill="currentColor"/></svg>
                    <span>LinkedIn</span>
                </a>
                <a href="https://github.com/gopu-inc/GoLV-VM" target="_blank" class="comm-card">
                    <svg viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" fill="currentColor"/></svg>
                    <span>GitHub</span>
                </a>
                <a href="https://twitch.tv/gopuinc" target="_blank" class="comm-card" style="border-color: #9146ff;">
                   <svg viewBox="0 0 24 24"><path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z" fill="currentColor"/></svg>
                   <span>Twitch</span>
                </a>
            </div>
        </div>

        <div id="view-login" class="auth-box">
            <h2 style="text-align: center; margin-bottom: 20px;">Connexion Server</h2>
            <div id="login-error" class="error-msg"></div>
            <input type="text" id="login-user" placeholder="Nom d'utilisateur" />
            <input type="password" id="login-pass" placeholder="Mot de passe" />
            <button onclick="handleLogin()">SE CONNECTER</button>
            <button class="secondary-btn" onclick="toggleAuthMode()">Créer un compte</button>
        </div>

        <div id="view-register" class="auth-box hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">Rejoindre GoPu</h2>
            <div id="reg-error" class="error-msg"></div>
            <input type="text" id="reg-user" placeholder="Nom d'utilisateur" />
            <input type="password" id="reg-pass" placeholder="Mot de passe" />
            <button onclick="handleRegister()">S'INSCRIRE</button>
            <button class="secondary-btn" onclick="toggleAuthMode()">J'ai déjà un compte</button>
        </div>

        <div id="view-dashboard" class="hidden">
            <h2 style="margin-bottom: 15px;">Mes Serveurs Virtuels</h2>
            <div id="vm-container" class="vm-list">
                <div style="text-align:center; color: var(--text-dim); padding: 40px;">Chargement...</div>
            </div>
        </div>

        <div id="view-create" class="create-vm-box hidden">
            <h2 style="margin-bottom: 20px;">Nouveau Server</h2>
            <div id="create-error" class="error-msg"></div>
            <input type="text" id="vm-name" placeholder="Nom du serveur" />
            <select id="vm-type">
                <option value="ubuntu">Ubuntu Server</option>
                <option value="debian">Debian</option>
                <option value="python-dev">Python Dev Env</option>
                <option value="nodejs">Node.js</option>
                <option value="docker-host">Docker Host</option>
            </select>
            <select id="vm-version">
                <option value="latest">Latest Stable</option>
                <option value="lts">LTS Version</option>
            </select>
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="vm-public" style="width: auto; margin:0;"> Public (Partager avec la communauté)
                </label>
            </div>
            <button onclick="handleCreateVM()">DÉPLOYER</button>
            <button class="secondary-btn" onclick="showDashboard()">Annuler</button>
        </div>

    </div>

    <div id="vm-window" class="window-manager">
        <div class="window-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <svg viewBox="0 0 24 24" style="width:20px; fill:var(--primary);"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/></svg>
                <span id="active-vm-name">VM-Terminal</span>
            </div>
            <button onclick="closeVMWindow()" style="width: auto; padding: 5px 10px; background: var(--danger); font-size: 12px;">FERMER</button>
        </div>
        
        <div style="background: #252830; padding: 5px; display: flex; gap: 10px; border-bottom: 1px solid var(--border);">
            <button onclick="switchTab('term')" style="width:auto; padding: 5px 15px; background: #333; font-size: 0.8rem;">> Terminal</button>
            <button onclick="switchTab('info')" style="width:auto; padding: 5px 15px; background: transparent; border:none; color: #888; font-size: 0.8rem;">Info</button>
        </div>

        <div id="tab-term" class="terminal" onclick="document.getElementById('cmd-input').focus()">
            <div class="terminal-output" id="term-output">
                <div>Connexion au socket sécurisé...</div>
                <div>Authentification réussie. Bienvenue sur GoLV Cloud.</div>
                <div style="color: #666">Type 'help' for available commands.</div>
                <br>
            </div>
            <div class="cmd-input-area">
                <span style="color: var(--primary); margin-right: 8px;">root@golv:~#</span>
                <input type="text" id="cmd-input" autocomplete="off" style="flex:1; color: white;">
            </div>
        </div>

        <div id="tab-info" class="terminal hidden" style="background: var(--bg); color: var(--text);">
            <div style="padding: 20px;">
                <h3>Status du Serveur</h3>
                <p id="vm-info-details">Chargement...</p>
                <hr style="border-color: var(--border); margin: 15px 0;">
                <p>Host: golv.onrender.com</p>
                <p>Owner: <span id="vm-owner">Me</span></p>
            </div>
        </div>
    </div>

    <button id="fab-create" class="fab hidden" onclick="showCreateVM()">+</button>

    <script>
        // CONFIG
        const API_URL = "https://golv.onrender.com";
        let CURRENT_USER = null;
        let TOKEN = localStorage.getItem('golv_token');
        let ACTIVE_VM_ID = null;

        // --- AUTH LOGIC ---
        
        async function checkAuth() {
            if (!TOKEN) {
                showLogin();
                return;
            }
            try {
                const res = await fetch(`${API_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                if (res.ok) {
                    CURRENT_USER = await res.json();
                    updateUIUser();
                    showDashboard();
                } else {
                    logout();
                }
            } catch (e) {
                console.error("Auth check fail", e);
                // If server is sleeping, it might fail. Don't logout immediately in prod usually, but here:
                showToast("Erreur de connexion au serveur...");
            }
        }

        function updateUIUser() {
            document.getElementById('username-span').innerText = CURRENT_USER.username;
            document.getElementById('user-display').classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('golv_token');
            TOKEN = null;
            CURRENT_USER = null;
            document.getElementById('user-display').classList.add('hidden');
            showLogin();
        }

        async function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const btn = document.querySelector('#view-login button');
            
            btn.innerText = "CONNEXION..."; btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                
                if (res.ok) {
                    TOKEN = data.access_token;
                    localStorage.setItem('golv_token', TOKEN);
                    await checkAuth();
                } else {
                    document.getElementById('login-error').innerText = data.detail || "Erreur login";
                }
            } catch (e) {
                document.getElementById('login-error').innerText = "Erreur réseau. Le serveur dort peut-être?";
            } finally {
                btn.innerText = "SE CONNECTER"; btn.disabled = false;
            }
        }

        async function handleRegister() {
            const u = document.getElementById('reg-user').value;
            const p = document.getElementById('reg-pass').value;
            
            try {
                const res = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                if (res.ok) {
                    // Auto login after register
                    document.getElementById('login-user').value = u;
                    document.getElementById('login-pass').value = p;
                    handleLogin();
                } else {
                    const data = await res.json();
                    document.getElementById('reg-error').innerText = data.detail || "Erreur";
                }
            } catch (e) {
                document.getElementById('reg-error').innerText = "Erreur réseau";
            }
        }

        // --- VIEW MANAGEMENT ---

        function hideAllViews() {
            ['view-login', 'view-register', 'view-dashboard', 'view-create'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('fab-create').classList.add('hidden');
        }

        function showLogin() {
            hideAllViews();
            document.getElementById('view-login').classList.remove('hidden');
        }

        function toggleAuthMode() {
            const login = document.getElementById('view-login');
            const reg = document.getElementById('view-register');
            if (login.classList.contains('hidden')) {
                login.classList.remove('hidden'); reg.classList.add('hidden');
            } else {
                login.classList.add('hidden'); reg.classList.remove('hidden');
            }
        }

        async function showDashboard() {
            hideAllViews();
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('fab-create').classList.remove('hidden');
            await loadVMs();
        }

        function showCreateVM() {
            hideAllViews();
            document.getElementById('view-create').classList.remove('hidden');
        }

        // --- VM LOGIC ---

        async function loadVMs() {
            const container = document.getElementById('vm-container');
            container.innerHTML = '<div style="text-align:center; padding:20px;">Chargement des données...</div>';

            try {
                const res = await fetch(`${API_URL}/api/vms?limit=50`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const json = await res.json();
                
                if (json.data && json.data.length > 0) {
                    container.innerHTML = '';
                    json.data.forEach(vm => {
                        const card = document.createElement('div');
                        card.className = 'vm-card';
                        card.innerHTML = `
                            <div>
                                <div style="display:flex; align-items:center; margin-bottom:5px;">
                                    <span class="vm-status ${vm.status === 'running' ? 'running' : ''}"></span>
                                    <strong style="font-size:1.1rem;">${vm.name}</strong>
                                </div>
                                <div style="font-size:0.85rem; color:var(--text-dim);">
                                    ${vm.vm_type} • ${vm.version} • ${vm.owner_name}
                                </div>
                            </div>
                            <button onclick="openVM('${vm.id}', '${vm.name}')" style="width:auto; padding:8px 15px; font-size:0.9rem;">
                                TERMINAL >
                            </button>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<div style="text-align:center; color:gray;">Aucune VM trouvée. Créez-en une !</div>';
                }

            } catch (e) {
                container.innerHTML = '<div style="color:red; text-align:center;">Erreur de chargement.</div>';
            }
        }

        async function handleCreateVM() {
            const name = document.getElementById('vm-name').value;
            const type = document.getElementById('vm-type').value;
            const ver = document.getElementById('vm-version').value;
            const isPub = document.getElementById('vm-public').checked;
            
            if(!name) return;

            const btn = document.querySelector('#view-create button');
            btn.disabled = true; btn.innerText = "DÉPLOIEMENT...";

            try {
                const res = await fetch(`${API_URL}/api/vms`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        vm_type: type,
                        version: ver,
                        is_public: isPub,
                        description: "Created via Mobile Web"
                    })
                });

                if (res.ok) {
                    showToast("Serveur déployé avec succès !");
                    showDashboard();
                    // Reset form
                    document.getElementById('vm-name').value = "";
                } else {
                    const d = await res.json();
                    document.getElementById('create-error').innerText = d.detail || "Erreur";
                }
            } catch (e) {
                document.getElementById('create-error').innerText = "Erreur serveur";
            } finally {
                btn.disabled = false; btn.innerText = "DÉPLOYER";
            }
        }

        // --- TERMINAL LOGIC ---

        function openVM(id, name) {
            ACTIVE_VM_ID = id;
            document.getElementById('active-vm-name').innerText = name;
            document.getElementById('vm-window').style.display = 'flex';
            document.getElementById('term-output').innerHTML = '<div>Initialisation de la session sécurisée...</div>';
            
            // Initial Status Check
            executeCommand('echo "Connecté à ' + name + '"');
            executeCommand('uname -a');
        }

        function closeVMWindow() {
            document.getElementById('vm-window').style.display = 'none';
            ACTIVE_VM_ID = null;
        }

        // Handle Command Input
        document.getElementById('cmd-input').addEventListener('keypress', async function (e) {
            if (e.key === 'Enter') {
                const cmd = this.value;
                if (!cmd) return;
                
                this.value = '';
                addTermLine(`root@golv:~# ${cmd}`, 'white');
                
                if (cmd === 'clear') {
                    document.getElementById('term-output').innerHTML = '';
                    return;
                }
                if (cmd === 'exit') {
                    closeVMWindow();
                    return;
                }

                await executeCommand(cmd);
            }
        });

        function addTermLine(text, color = '#00ff88') {
            const div = document.createElement('div');
            div.innerText = text;
            div.style.color = color;
            const out = document.getElementById('term-output');
            out.appendChild(div);
            // Scroll to bottom
            const term = document.getElementById('tab-term');
            term.scrollTop = term.scrollHeight;
        }

        async function executeCommand(cmdStr) {
            if (!ACTIVE_VM_ID) return;
            
            try {
                // Determine if it matches predefined or raw
                // Based on backend, we can use raw execute for flexibility
                const payload = {
                    command: cmdStr,
                    timeout: 30,
                    working_dir: "/root"
                };

                const res = await fetch(`${API_URL}/api/vms/${ACTIVE_VM_ID}/execute`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.data && data.data.stdout) {
                    addTermLine(data.data.stdout);
                }
                if (data.data && data.data.stderr) {
                    addTermLine(data.data.stderr, '#ff4757');
                }
                if (!data.success) {
                    addTermLine("Error: " + (data.error || "Command failed"), '#ff4757');
                }

            } catch (e) {
                addTermLine("Erreur de communication avec le terminal.", '#ff4757');
            }
        }

        function switchTab(tab) {
            if (tab === 'term') {
                document.getElementById('tab-term').classList.remove('hidden');
                document.getElementById('tab-info').classList.add('hidden');
            } else {
                document.getElementById('tab-term').classList.add('hidden');
                document.getElementById('tab-info').classList.remove('hidden');
                // Fetch info
                fetchVMInfo();
            }
        }

        async function fetchVMInfo() {
            if(!ACTIVE_VM_ID) return;
            try {
                const res = await fetch(`${API_URL}/api/vms/${ACTIVE_VM_ID}/status`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const d = await res.json();
                document.getElementById('vm-info-details').innerHTML = `
                    Status: <b>${d.status.status}</b><br>
                    Size: ${d.status.size_human || '0 B'}<br>
                    Files: ${d.status.file_count || 0}
                `;
            } catch(e) {
                document.getElementById('vm-info-details').innerText = "Erreur info";
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // Init
        checkAuth();

    </script>
</body>
</html>
